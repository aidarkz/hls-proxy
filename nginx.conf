worker_processes  1;

events {
    worker_connections  1024;
}

http {
    # Кеш в tmpfs (памяти)
    proxy_cache_path /tmp/nginx_cache keys_zone=cache_zone:50m max_size=100m inactive=10m use_temp_path=off;

    resolver 8.8.8.8 ipv6=off;  # для резолва внешних DNS

    server {
        listen 80;

        location /proxy/ {
            internal;
            # Отрезаем /proxy/ из URI и проксируем дальше
            proxy_cache cache_zone;
            proxy_cache_valid 200 302 10m;
            proxy_cache_use_stale error timeout updating;
            proxy_cache_background_update on;

            set $upstream_host "";
            set $upstream_scheme "http";

            # Получаем хост и URI из запроса, например:
            # /proxy/ledir.thund.re:80/play/live.php?mac=...&stream=...&extension=ts
            # Превратим в http://ledir.thund.re:80/play/live.php?...

            # Извлечь хост и порт из URI
            if ($request_uri ~ "^/proxy/(?<host>[^/]+)(?<uri>/.*)$") {
                set $upstream_host $host;
                set $upstream_uri $uri;
            }

            proxy_pass $upstream_scheme://$upstream_host$upstream_uri$is_args$args;

            proxy_set_header Host $upstream_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Чтобы не возвращать 404 на обычный /
        location / {
            return 200 "Proxy running\n";
        }
    }
}
